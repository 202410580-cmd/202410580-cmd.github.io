<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>TRPG 맵</title>
<style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    #map {
        position: relative;
        width: 1000px;
        height: 600px;
        margin: 20px auto;
        border: 2px solid #000;
        background-color: #e0e0e0;
    }
    .char {
        position: absolute;
        width: 50px;
        height: 50px;
        cursor: pointer;
        text-align: center;
        font-size: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.6);
        border-radius: 6px;
    }
    .char img {
        width: 40px;
        height: 40px;
        border-radius: 5px;
        object-fit: cover;
    }
    #chatContainer {
        position: fixed;
        bottom: 180px;
        right: 100px;
        width: 300px;  
        height: 610px;
        background: rgba(255,255,255,0.9);
        border: 2px solid #000;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
    }
    #chatMessages {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        font-size: 14px;
        text-align: left;
        border-bottom: 1px solid #ccc;
    }
    #chatInputContainer {
        display: flex;
    }
    #chatInput {
        flex: 1;
        padding: 5px;
        font-size: 14px;
        border: none;
        outline: none;
    }
    #chatSend {
        padding: 5px 10px;
        cursor: pointer;
        border: none;
        background: #007bff;
        color: white;
    }
    #arrowControls {
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 120px;
        height: 120px;
        display: grid;
        grid-template-columns: repeat(3, 40px);
        grid-template-rows: repeat(3, 40px);
        gap: 5px;
    }
    .arrow-btn {
        background: #fff;
        border: 2px solid #000;
        border-radius: 5px;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        user-select: none;
    }
    .arrow-btn:active {
        background: #ddd;
    }
</style>
</head>
<body>

<h1>TRPG 맵</h1>

<label>맵에 올릴 캐릭터 선택:</label>
<select id="charSelect">
    <option value="">선택하세요</option>
</select>
<button onclick="addCharacter()">맵에 추가</button>

<div id="map"></div>
<div id="chatContainer">
    <div style="padding:5px; border-bottom:1px solid #ccc;">
        <input type="text" id="chatName" placeholder="닉네임 입력" style="width:90%; padding:5px;">
    </div>
    <div id="chatMessages"></div>
    <div id="chatInputContainer">
        <input type="text" id="chatInput" placeholder="메시지를 입력하세요">
        <button id="chatSend">전송</button>
    </div>
</div>

<!-- 화살표 컨트롤은 스크립트보다 먼저 두거나, 스크립트를 body 끝으로 옮기면 안전 -->
<div id="arrowControls">
    <div></div>
    <div class="arrow-btn" data-dir="up">↑</div>
    <div></div>
    <div class="arrow-btn" data-dir="left">←</div>
    <div></div>
    <div class="arrow-btn" data-dir="right">→</div>
    <div></div>
    <div class="arrow-btn" data-dir="down">↓</div>
    <div></div>
</div>

<script>
let map = document.getElementById('map');
let charSelect = document.getElementById('charSelect');
let chatName = document.getElementById('chatName');
let characters = JSON.parse(localStorage.getItem("characterList") || "[]");
let activeChar = null;

// 샘플 캐릭터가 로컬스토리지에 없으면 예시 하나 넣어두기 (테스트용)
if(characters.length === 0) {
    characters = [
        { name: "전사", img: "" },
        { name: "도적", img: "" },
        { name: "마법사", img: "" }
    ];
    // localStorage.setItem("characterList", JSON.stringify(characters)); // 원하면 저장
}

characters.forEach((char, index) => {
    const option = document.createElement('option');
    option.value = index;
    option.textContent = char.name;
    charSelect.appendChild(option);
});

function addCharacter() {
    const index = charSelect.value;
    if(index === "") return;

    const charData = characters[index];

    const charDiv = document.createElement('div');
    charDiv.className = 'char';
    charDiv.style.top = '0px';
    charDiv.style.left = '0px';
    charDiv.dataset.index = index;

    charDiv.innerHTML = `
        ${charData.img ? `<img src="${charData.img}" alt="${charData.name}">` : `<div style="width:40px; height:40px; background:#666; border-radius:4px;"></div>`}
        <div style="margin-top:2px; font-size:12px;">${charData.name}</div>
    `;

    charDiv.addEventListener('click', function(e) {
        activeChar = charDiv;
        document.querySelectorAll('.char').forEach(c => c.style.border = '');
        activeChar.style.border = '2px solid red';
        e.stopPropagation();
    });

    map.appendChild(charDiv);
}

// 맵의 빈 공간을 클릭하면 선택 해제
map.addEventListener('click', function() {
    activeChar = null;
    document.querySelectorAll('.char').forEach(c => c.style.border = '');
});

// 키보드 화살표 이동
document.addEventListener('keydown', function(e) {
    if(!activeChar) return;

    const step = 10;
    let top = parseInt(activeChar.style.top || '0', 10);
    let left = parseInt(activeChar.style.left || '0', 10);

    switch(e.key){
        case 'ArrowUp': top -= step; break;
        case 'ArrowDown': top += step; break;
        case 'ArrowLeft': left -= step; break;
        case 'ArrowRight': left += step; break;
        default: return;
    }
    top = Math.max(0, Math.min(map.clientHeight - activeChar.clientHeight, top));
    left = Math.max(0, Math.min(map.clientWidth - activeChar.clientWidth, left));

    activeChar.style.top = top + 'px';
    activeChar.style.left = left + 'px';
});

// 채팅
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');
const chatMessages = document.getElementById('chatMessages');

function addChatMessage(msg) {
    const name = (chatName && chatName.value.trim()) || "익명";
    const p = document.createElement('p');
    p.textContent = `${name}: ${msg}`;
    chatMessages.appendChild(p);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

chatSend.addEventListener('click', function() {
    const msg = chatInput.value.trim();
    if(msg !== '') {
        addChatMessage(msg);
        chatInput.value = '';
    }
});

chatInput.addEventListener('keypress', function(e) {
    if(e.key === 'Enter') {
        chatSend.click();
    }
});

// === 방향키 버튼 클릭 시 토큰 이동 (이벤트 위임 방식) ===
const arrowControls = document.getElementById('arrowControls');
arrowControls.addEventListener('click', function(e) {
    const btn = e.target.closest('.arrow-btn');
    if(!btn) return;
    if (!activeChar) return;

    const dir = btn.dataset.dir;
    const step = 10;

    let top = parseInt(activeChar.style.top || '0', 10);
    let left = parseInt(activeChar.style.left || '0', 10);

    switch(dir) {
        case 'up': top -= step; break;
        case 'down': top += step; break;
        case 'left': left -= step; break;
        case 'right': left += step; break;
    }

    top = Math.max(0, Math.min(map.clientHeight - activeChar.clientHeight, top));
    left = Math.max(0, Math.min(map.clientWidth - activeChar.clientWidth, left));

    activeChar.style.top = top + 'px';
    activeChar.style.left = left + 'px';
});
</script>

</body>
</html>
